// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Users and Authentication
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  phone     String   @unique
  password  String
  role      String   @default("user") // admin, support, technician, customer
  name      String?
  avatar    String?
  status    String   @default("active") // active, inactive, suspended
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tickets   Ticket[]
  payments  Payment[]
  employees Employee?
  accounts  Account[]

  @@index([email])
  @@index([phone])
}

// Customers
model Customer {
  id            String   @id @default(cuid())
  phone         String   @unique
  email         String   @unique
  name          String
  accountType   String? // residential, business
  status        String   @default("active") // active, suspended, inactive
  registeredAt  DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  accounts Account[]
  tickets  Ticket[]
  payments Payment[]

  @@index([phone])
  @@index([email])
}

// ISP Accounts (Mikrotik/RouterOS accounts)
model Account {
  id                String   @id @default(cuid())
  customerId        String
  userId            String?
  username          String   @unique
  password          String
  ipAddress         String?
  macAddress        String?
  plan              String?
  bandwidth         String? // e.g., "10Mbps", "50Mbps"
  status            String   @default("active") // active, suspended, expired, inactive
  expiryDate        DateTime?
  lastPaymentDate   DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  customer  Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id])
  invoices  Invoice[]
  payments  Payment[]

  @@index([customerId])
  @@index([userId])
  @@index([username])
}

// Invoices
model Invoice {
  id            String   @id @default(cuid())
  accountId     String
  invoiceNumber String   @unique
  amount        Float
  status        String   @default("pending") // pending, paid, overdue, cancelled
  dueDate       DateTime
  issuedDate    DateTime @default(now())
  paidDate      DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@index([accountId])
  @@index([invoiceNumber])
}

// Payments
model Payment {
  id                  String   @id @default(cuid())
  invoiceId           String?
  accountId           String
  userId              String?
  customerId          String?
  amount              Float
  paymentMethod       String   @default("mpesa") // mpesa, bank-transfer, cash, check
  mpesaReceiptNumber  String?
  transactionId       String?
  status              String   @default("pending") // pending, completed, failed
  paymentDate         DateTime @default(now())
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  invoice    Invoice?  @relation(fields: [invoiceId], references: [id])
  account    Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  user       User?     @relation(fields: [userId], references: [id])
  customer   Customer? @relation(fields: [customerId], references: [id])

  @@index([invoiceId])
  @@index([accountId])
  @@index([userId])
  @@index([customerId])
}

// Support Tickets
model Ticket {
  id          String   @id @default(cuid())
  ticketId    String   @unique
  customerId  String
  userId      String?
  subject     String
  description String
  category    String? // technical, billing, complaint, general
  priority    String   @default("medium") // low, medium, high, urgent
  status      String   @default("open") // open, in-progress, resolved, closed
  resolution  String?
  createdAt   DateTime @default(now())
  resolvedAt  DateTime?
  updatedAt   DateTime @updatedAt

  // Relations
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  user     User?    @relation(fields: [userId], references: [id])

  @@index([customerId])
  @@index([userId])
  @@index([ticketId])
}

// Employees (HRM)
model Employee {
  id              String   @id @default(cuid())
  userId          String   @unique
  firstName       String
  lastName        String
  email           String   @unique
  phone           String   @unique
  position        String?
  department      String?
  salary          Float?
  hireDate        DateTime
  status          String   @default("active") // active, on_leave, inactive
  emergencyContact String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([email])
}

// Settings
model AppSettings {
  id             String   @id @default(cuid())
  key            String   @unique
  value          String?
  category       String? // sms, whatsapp, mpesa, company, system
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([key])
  @@index([category])
}

// SMS Settings Storage
model SmsConfig {
  id            String   @id @default(cuid())
  provider      String   @default("advanta") // advanta, twilio, vonage, etc
  enabled       Boolean  @default(false)
  apiKey        String?
  partnerId     String?
  shortcode     String?
  customApiUrl  String?
  accountSid    String?
  authToken     String?
  fromNumber    String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([provider])
}

// MPESA Settings Storage
model MpesaConfig {
  id               String   @id @default(cuid())
  enabled          Boolean  @default(false)
  consumerKey      String?
  consumerSecret   String?
  businessShortCode String?
  passkey          String?
  initiatorPassword String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

// Mikrotik/RouterOS Configuration
model MikrotikConfig {
  id                String   @id @default(cuid())
  apiUrl            String?
  username          String?
  password          String?
  enabled           Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// Audit Logs
model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  entity    String? // User, Customer, Account, etc
  entityId  String?
  changes   String? // JSON string of changes
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([entity])
  @@index([entityId])
}
