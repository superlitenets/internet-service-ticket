// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Users and Authentication
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  phone     String   @unique
  password  String
  role      String   @default("user") // admin, support, technician, customer
  name      String?
  avatar    String?
  status    String   @default("active") // active, inactive, suspended
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tickets      Ticket[]
  payments     Payment[]
  employees    Employee?
  accounts     Account[]
  leads        Lead[] @relation("leads")
  ticketReplies TicketReply[]

  @@index([email])
  @@index([phone])
}

// Customers
model Customer {
  id            String   @id @default(cuid())
  phone         String   @unique
  email         String   @unique
  name          String
  accountType   String? // residential, business
  location      String?  // City/Location
  apartment     String?  // Apartment/Unit number
  roomNumber    String?  // Room number
  streetAddress String?  // Street address
  status        String   @default("active") // active, suspended, inactive
  registeredAt  DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  accounts Account[]
  tickets  Ticket[]
  payments Payment[]

  @@index([phone])
  @@index([email])
}

// ISP Accounts (Mikrotik/RouterOS accounts)
model Account {
  id                String   @id @default(cuid())
  customerId        String
  userId            String?
  username          String   @unique
  password          String
  ipAddress         String?
  macAddress        String?
  plan              String?
  bandwidth         String? // e.g., "10Mbps", "50Mbps"
  status            String   @default("active") // active, suspended, expired, inactive
  expiryDate        DateTime?
  lastPaymentDate   DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  customer  Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id])
  invoices  Invoice[]
  payments  Payment[]

  @@index([customerId])
  @@index([userId])
  @@index([username])
}

// Invoices
model Invoice {
  id            String   @id @default(cuid())
  accountId     String
  invoiceNumber String   @unique
  amount        Float
  status        String   @default("pending") // pending, paid, overdue, cancelled
  dueDate       DateTime
  issuedDate    DateTime @default(now())
  paidDate      DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@index([accountId])
  @@index([invoiceNumber])
}

// Payments
model Payment {
  id                  String   @id @default(cuid())
  invoiceId           String?
  accountId           String
  userId              String?
  customerId          String?
  amount              Float
  paymentMethod       String   @default("mpesa") // mpesa, bank-transfer, cash, check
  mpesaReceiptNumber  String?
  transactionId       String?
  status              String   @default("pending") // pending, completed, failed
  paymentDate         DateTime @default(now())
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  invoice    Invoice?  @relation(fields: [invoiceId], references: [id])
  account    Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  user       User?     @relation(fields: [userId], references: [id])
  customer   Customer? @relation(fields: [customerId], references: [id])

  @@index([invoiceId])
  @@index([accountId])
  @@index([userId])
  @@index([customerId])
}

// Sales Leads
model Lead {
  id                    String   @id @default(cuid())
  customerName          String
  phone                 String
  email                 String?
  location              String
  package               String
  agreedInstallAmount   Float
  status                String   @default("new") // new, contacted, qualified, converted, lost
  createdById           String
  convertedToTicketId   String?
  convertedAt           DateTime?
  notes                 String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  createdBy User? @relation("leads", fields: [createdById], references: [id], onDelete: Cascade)

  @@index([createdById])
  @@index([status])
  @@index([phone])
  @@index([createdAt])
}

// Support Tickets
model Ticket {
  id                    String   @id @default(cuid())
  ticketId              String   @unique
  customerId            String
  userId                String?
  teamGroupId           String?  // Assign entire team group
  assignedTeamMemberId  String?  // Assign specific team member
  subject               String
  description           String
  category              String? // technical, billing, complaint, general
  priority              String   @default("medium") // low, medium, high, urgent
  status                String   @default("open") // open, in-progress, bounced, waiting, resolved, closed
  resolution            String?
  createdAt             DateTime @default(now())
  resolvedAt            DateTime?
  updatedAt             DateTime @updatedAt

  // Relations
  customer      Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  user          User?    @relation(fields: [userId], references: [id])
  teamGroup     TeamGroup? @relation(fields: [teamGroupId], references: [id], onDelete: SetNull)
  assignedTeamMember TeamMember? @relation(fields: [assignedTeamMemberId], references: [id], onDelete: SetNull)
  replies       TicketReply[]

  @@index([customerId])
  @@index([userId])
  @@index([teamGroupId])
  @@index([assignedTeamMemberId])
  @@index([ticketId])
}

// Ticket Replies/Comments (Discussion)
model TicketComment {
  id          String   @id @default(cuid())
  ticketId    String
  userId      String
  content     String
  isInternal  Boolean  @default(false) // true = staff only, false = customer visible
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([userId])
}

// Keep TicketReply for backward compatibility
model TicketReply {
  id        String   @id @default(cuid())
  ticketId  String
  userId    String
  message   String
  isInternal Boolean  @default(false) // true = only staff can see, false = customer can see
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([userId])
}

// Ticket Tasks/Subtasks
model TicketTask {
  id              String   @id @default(cuid())
  ticketId        String
  title           String
  description     String?
  assignedTo      String?  // Employee/User ID
  status          String   @default("open") // open, in-progress, completed, blocked
  priority        String   @default("medium") // low, medium, high, critical
  estimatedHours  Float?
  completedAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  assignee User? @relation(fields: [assignedTo], references: [id])
  timeLogs TimeLog[]

  @@index([ticketId])
  @@index([assignedTo])
  @@index([status])
}

// Time Logging
model TimeLog {
  id          String   @id @default(cuid())
  taskId      String?  // If null, logged directly on ticket
  ticketId    String
  userId      String
  hours       Float
  description String?
  date        DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  task   TicketTask? @relation(fields: [taskId], references: [id], onDelete: SetNull)
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([taskId])
  @@index([userId])
  @@index([date])
}

// Activity Log (Audit Trail)
model ActivityLog {
  id          String   @id @default(cuid())
  ticketId    String
  userId      String?  // Null if system action
  action      String   // created, assigned, status_changed, commented, task_added, etc
  changes     String?  // JSON of what changed
  description String?
  createdAt   DateTime @default(now())

  // Relations
  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([ticketId])
  @@index([userId])
  @@index([createdAt])
  @@index([action])
}

// SLA Policies
model SLAPolicy {
  id                String   @id @default(cuid())
  name              String   @unique
  description       String?
  priority          String   // low, medium, high, critical
  responseTimeHours Int      // Max time to first response
  resolutionTimeHours Int    // Max time to resolve
  enabled           Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  tickets Ticket[]

  @@index([priority])
}

// Update Ticket to include tasks, time logs, activity logs, and SLA policy
// (This is just a comment - the Ticket model is already defined above with basic relations)

// Performance Metrics (for reporting)
model PerformanceMetric {
  id                    String   @id @default(cuid())
  userId                String
  employeeName          String?
  period                DateTime // Month/week of the metric
  ticketsHandled        Int      @default(0)
  ticketsResolved       Int      @default(0)
  ticketsOverdue        Int      @default(0)
  avgResolutionHours    Float    @default(0)
  totalHoursLogged      Float    @default(0)
  slaCompliancePercent  Float    @default(100) // 0-100
  customerSatisfaction  Float?   // Average rating
  taskCompletionPercent Float    @default(100) // % of assigned tasks completed
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, period])
  @@index([userId])
  @@index([period])
}

// Departments (HRM)
model Department {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  manager     String?  // Employee ID of department manager
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  employees TeamMember[]

  @@index([name])
}

// Team Groups (for organizing employees into teams - can span multiple departments)
model TeamGroup {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  departmentId String?  // Optional: primary department, members can be from other departments
  manager     String?  // Employee ID of team lead
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  members     TeamMember[]
  assignedTickets Ticket[]

  @@index([departmentId])
  @@index([name])
}

// Team Members (associates employees with teams/departments)
model TeamMember {
  id          String   @id @default(cuid())
  employeeId  String
  departmentId String?
  teamGroupId String?
  role        String?  // Member, Lead, Manager
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  department  Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  teamGroup   TeamGroup?  @relation(fields: [teamGroupId], references: [id], onDelete: SetNull)
  assignedTickets Ticket[]

  @@unique([employeeId, departmentId, teamGroupId])
  @@index([employeeId])
  @@index([departmentId])
  @@index([teamGroupId])
}

// Employees (HRM)
model Employee {
  id              String   @id @default(cuid())
  userId          String?  @unique
  firstName       String
  lastName        String
  email           String   @unique
  phone           String   @unique
  position        String?
  department      String?  // Kept for backward compatibility
  salary          Float?
  hireDate        DateTime
  status          String   @default("active") // active, on_leave, inactive
  emergencyContact String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([email])
}

// Settings
model AppSettings {
  id             String   @id @default(cuid())
  key            String   @unique
  value          String?
  category       String? // sms, whatsapp, mpesa, company, system
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([key])
  @@index([category])
}

// SMS Settings Storage
model SmsConfig {
  id            String   @id @default(cuid())
  provider      String   @default("advanta") // advanta, twilio, vonage, etc
  enabled       Boolean  @default(false)
  apiKey        String?
  partnerId     String?
  shortcode     String?
  customApiUrl  String?
  accountSid    String?
  authToken     String?
  fromNumber    String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([provider])
}

// MPESA Settings Storage
model MpesaConfig {
  id               String   @id @default(cuid())
  enabled          Boolean  @default(false)
  consumerKey      String?
  consumerSecret   String?
  businessShortCode String?
  passkey          String?
  initiatorPassword String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

// Mikrotik/RouterOS Configuration
model MikrotikConfig {
  id                String   @id @default(cuid())
  apiUrl            String?
  username          String?
  password          String?
  enabled           Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// Audit Logs
model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  entity    String? // User, Customer, Account, etc
  entityId  String?
  changes   String? // JSON string of changes
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([entity])
  @@index([entityId])
}

// Journal Entries for General Ledger
model JournalEntry {
  id            String   @id @default(cuid())
  entryNumber   String   @unique
  description   String
  referenceNo   String? // Invoice #, Expense #, etc
  debitAccountCode  String
  creditAccountCode String
  amount        Float
  entryDate     DateTime @default(now())
  status        String   @default("posted") // draft, posted, reversed
  reversedBy    String? // JournalEntry ID if reversed
  createdBy     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  debitAccount  ChartOfAccount @relation("debit", fields: [debitAccountCode], references: [accountCode], onDelete: Restrict)
  creditAccount ChartOfAccount @relation("credit", fields: [creditAccountCode], references: [accountCode], onDelete: Restrict)

  @@index([entryDate])
  @@index([status])
  @@index([debitAccountCode])
  @@index([creditAccountCode])
}

// Chart of Accounts for General Ledger
model ChartOfAccount {
  id          String   @id @default(cuid())
  accountCode String   @unique // e.g., 1000, 2000, 3000
  accountName String
  type        String   // Asset, Liability, Equity, Revenue, Expense
  category    String? // e.g., Cash, Bank, Equipment, etc
  description String?
  balance     Float    @default(0)
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  debitEntries  JournalEntry[] @relation("debit")
  creditEntries JournalEntry[] @relation("credit")

  @@index([accountCode])
  @@index([type])
}

// Expense Categories
model ExpenseCategory {
  id       String    @id @default(cuid())
  name     String    @unique
  code     String    @unique
  type     String    // Fixed, Variable, Capital
  enabled  Boolean   @default(true)
  expenses Expense[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
}

// Expenses
model Expense {
  id              String   @id @default(cuid())
  expenseNumber   String   @unique
  categoryId      String
  description     String
  amount          Float
  vendor          String?
  paymentMethod   String   @default("cash") // cash, bank-transfer, mpesa, check
  referenceNo     String? // Receipt #, Check #, etc
  status          String   @default("draft") // draft, submitted, approved, paid, rejected
  attachmentUrl   String?
  expenseDate     DateTime
  approvedBy      String?
  approvedAt      DateTime?
  paidAt          DateTime?
  createdBy       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  category ExpenseCategory @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  @@index([categoryId])
  @@index([status])
  @@index([expenseDate])
}

// POS Items (Inventory for POS)
model POSItem {
  id           String   @id @default(cuid())
  sku          String   @unique
  name         String
  description  String?
  category     String?
  unitPrice    Float
  quantity     Int      @default(0)
  reorderLevel Int      @default(10)
  enabled      Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  transactionItems POSTransactionItem[]

  @@index([sku])
  @@index([category])
}

// POS Transactions
model POSTransaction {
  id              String   @id @default(cuid())
  receiptNumber   String   @unique
  customerId      String?
  customerName    String?
  subtotal        Float
  taxAmount       Float    @default(0)
  discountAmount  Float    @default(0)
  totalAmount     Float
  paymentMethod   String   @default("cash") // cash, card, mpesa, check
  paymentStatus   String   @default("completed") // pending, completed, refunded
  cashier         String?
  notes           String?
  transactionDate DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  items POSTransactionItem[]

  @@index([receiptNumber])
  @@index([transactionDate])
  @@index([paymentStatus])
}

// POS Transaction Items
model POSTransactionItem {
  id              String   @id @default(cuid())
  transactionId   String
  itemId          String
  quantity        Int
  unitPrice       Float
  lineTotal       Float
  discount        Float    @default(0)
  createdAt       DateTime @default(now())

  // Relations
  transaction POSTransaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  item        POSItem       @relation(fields: [itemId], references: [id], onDelete: Restrict)

  @@index([transactionId])
  @@index([itemId])
}

// Accounting Summary/Trial Balance (cached)
model AccountingSummary {
  id          String   @id @default(cuid())
  summaryDate DateTime
  totalAssets Float    @default(0)
  totalLiabilities Float @default(0)
  totalEquity Float    @default(0)
  totalRevenue Float   @default(0)
  totalExpenses Float  @default(0)
  netProfit   Float    @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([summaryDate])
}
